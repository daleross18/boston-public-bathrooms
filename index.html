<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Runner Bathroom Map - Cambridge/Boston</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
  #map { height: 100vh; width: 100%; }
  .legend {
    background: white; padding: 12px 16px; border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.3); line-height: 1.6; font-size: 13px;
    max-height: 70vh; overflow-y: auto;
  }
  .legend h3 { margin-bottom: 8px; font-size: 14px; font-weight: 600; }
  .download-btn {
    background: #4285F4; color: white; border: none; padding: 10px 16px;
    border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer;
    margin-bottom: 12px; width: 100%; transition: background 0.2s;
  }
  .download-btn:hover { background: #3367D6; }
  .legend-item {
    display: flex; align-items: center; gap: 8px; cursor: pointer;
    padding: 4px 6px; border-radius: 4px; transition: background-color 0.2s;
    margin-bottom: 2px;
  }
  .legend-item:hover { background-color: rgba(0,0,0,0.05); }
  .legend-dot {
    width: 28px; height: 28px; border-radius: 50%; flex-shrink: 0;
    border: 2px solid rgba(255,255,255,0.9);
    box-shadow: 0 0 4px rgba(0,0,0,0.3);
    display: flex; align-items: center; justify-content: center;
    font-size: 14px; font-weight: bold; color: white;
    text-shadow: 0 0 2px rgba(0,0,0,0.8);
    transition: opacity 0.2s;
  }
  .legend-item.dimmed .legend-dot {
    opacity: 0.3;
  }
  .legend-item.dimmed { opacity: 0.5; }
  .legend-separator {
    border-top: 1px solid #ddd; margin: 8px 0; padding-top: 8px;
  }
  .leaflet-popup-content { font-size: 13px; line-height: 1.5; max-width: 280px; }
  .popup-title { font-weight: 700; font-size: 14px; margin-bottom: 4px; }
  .popup-tag {
    display: inline-block; padding: 1px 8px; border-radius: 10px;
    font-size: 11px; font-weight: 600; margin-bottom: 4px;
  }
  .tag-yearround { background: #d4edda; color: #155724; }
  .tag-seasonal { background: #fff3cd; color: #856404; }
  .tag-24hr { background: #cce5ff; color: #004085; }
  .tag-fountain { background: #d1ecf1; color: #0c5460; }
  .tag-open { background: #d4edda; color: #155724; }
  .tag-closed { background: #f8d7da; color: #721c24; }
  .tag-unknown { background: #e2e3e5; color: #383d41; }

  /* Water fountain badge on dual-purpose markers */
  .wf-badge {
    display: none;
    position: absolute; bottom: -4px; right: -6px;
    font-size: 12px; line-height: 1;
    background: white; border-radius: 50%;
    width: 18px; height: 18px;
    align-items: center; justify-content: center;
    box-shadow: 0 0 3px rgba(0,0,0,0.4);
    z-index: 1;
  }
  .show-fountains .wf-badge { display: flex; }

  /* Mobile toggle button (hidden on desktop) */
  .legend-toggle-btn {
    display: none;
    position: fixed; bottom: 20px; right: 16px; z-index: 1000;
    width: 52px; height: 52px; border-radius: 50%;
    background: #4285F4; color: white; border: none;
    box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    font-size: 22px; cursor: pointer;
    align-items: center; justify-content: center;
    -webkit-tap-highlight-color: transparent;
  }
  .legend-toggle-btn:active { background: #3367D6; }

  /* Mobile bottom sheet overlay */
  .legend-overlay {
    display: none;
    position: fixed; inset: 0; z-index: 1001;
    background: rgba(0,0,0,0.4);
    -webkit-tap-highlight-color: transparent;
  }

  /* Mobile bottom sheet */
  .legend-sheet {
    display: none;
    position: fixed; bottom: 0; left: 0; right: 0; z-index: 1002;
    background: white;
    border-radius: 16px 16px 0 0;
    box-shadow: 0 -4px 20px rgba(0,0,0,0.15);
    max-height: 70vh; overflow-y: auto;
    padding: 8px 16px 24px;
    transform: translateY(100%);
    transition: transform 0.3s ease;
    -webkit-overflow-scrolling: touch;
  }
  .legend-sheet.open { transform: translateY(0); }
  .legend-sheet .sheet-handle {
    width: 36px; height: 4px; border-radius: 2px;
    background: #ccc; margin: 4px auto 12px;
  }
  .legend-sheet .sheet-header {
    display: flex; align-items: center; justify-content: space-between;
    margin-bottom: 8px;
  }
  .legend-sheet .sheet-header h3 { margin: 0; font-size: 15px; font-weight: 600; }
  .legend-sheet .sheet-close {
    background: none; border: none; font-size: 22px;
    color: #666; cursor: pointer; padding: 4px 8px;
    -webkit-tap-highlight-color: transparent;
  }
  .legend-sheet .legend-item {
    padding: 10px 8px;
    margin-bottom: 0;
  }
  .legend-sheet .download-btn {
    padding: 14px 16px; font-size: 15px;
  }

  /* Locate me button */
  .locate-btn {
    position: fixed; bottom: 20px; left: 16px; z-index: 1000;
    width: 44px; height: 44px; border-radius: 50%;
    background: white; color: #333; border: none;
    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    font-size: 20px; cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    -webkit-tap-highlight-color: transparent;
    transition: background 0.2s;
  }
  .locate-btn:hover { background: #f0f0f0; }
  .locate-btn:active { background: #e0e0e0; }
  .locate-btn.locating { animation: pulse-btn 1s ease infinite; }
  @keyframes pulse-btn {
    0%, 100% { box-shadow: 0 2px 8px rgba(0,0,0,0.3); }
    50% { box-shadow: 0 2px 8px rgba(66,133,244,0.6); }
  }

  /* User location blue dot */
  .user-location-dot {
    width: 16px; height: 16px;
    background: #4285F4;
    border: 3px solid white;
    border-radius: 50%;
    box-shadow: 0 0 8px rgba(66,133,244,0.5);
  }
  .user-location-ring {
    width: 40px; height: 40px;
    border: 2px solid rgba(66,133,244,0.3);
    background: rgba(66,133,244,0.1);
    border-radius: 50%;
    animation: pulse-ring 2s ease-out infinite;
  }
  @keyframes pulse-ring {
    0% { transform: scale(0.8); opacity: 1; }
    100% { transform: scale(2); opacity: 0; }
  }

  @media (max-width: 640px) {
    /* Hide the Leaflet legend control on mobile */
    .legend { display: none !important; }

    /* Show mobile UI */
    .legend-toggle-btn { display: flex; }

    .leaflet-popup-content { max-width: 220px; font-size: 12px; }
    .popup-title { font-size: 13px; }

    /* Nudge Leaflet zoom controls away from the toggle button */
    .leaflet-bottom.leaflet-right { bottom: 80px; }
  }
</style>
</head>
<body>
<div id="map"></div>

<button class="locate-btn" id="locateBtn" aria-label="Show my location" title="Show my location">&#x1F4CD;</button>

<!-- Mobile bottom sheet for legend -->
<button class="legend-toggle-btn" id="legendToggle" aria-label="Show filters">‚ò∞</button>
<div class="legend-overlay" id="legendOverlay"></div>
<div class="legend-sheet" id="legendSheet">
  <div class="sheet-handle"></div>
  <div class="sheet-header">
    <h3>Filters & Legend</h3>
    <button class="sheet-close" id="sheetClose" aria-label="Close">‚úï</button>
  </div>
  <div id="sheetContent"></div>
</div>

<script src="locations.js"></script>
<script>
// Colorblind-friendly palette (Okabe-Ito based)
const catColors = {
  university: "#CC79A7",      // mauve/pink - distinct
  public_bldg: "#F0E442",     // yellow - very bright
  hospital: "#D55E00",        // burnt orange - warm distinct
  transit: "#000000",         // black - strong contrast
  parks: "#E69F00",           // orange - warm
  recreation_centers: "#56B4E9", // sky blue - cool distinct
  sports_fields: "#009E73",   // teal/green - cool
  attractions: "#0072B2",     // dark blue - different from sports
  coffee: "#6F4E37",          // coffee brown - warm distinct
  hotel: "#8B5CF6",           // purple - distinct
  other: "#999999"            // gray - neutral
};

const catNames = {
  university: "University Buildings",
  public_bldg: "Public Buildings",
  hospital: "Hospitals / Health Centers",
  transit: "MBTA Stations",
  parks: "Parks & Public Spaces",
  recreation_centers: "Recreation Centers",
  sports_fields: "Sports Facilities",
  attractions: "Attractions (Museums, Zoo, etc)",
  coffee: "Coffee Shops",
  hotel: "Hotel Lobbies",
  other: "Other (retail, etc.)"
};

const map = L.map('map').setView([42.3620, -71.1050], 13);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap contributors',
  maxZoom: 19
}).addTo(map);

const markers = [];
const categoryVisible = {};
Object.keys(catColors).forEach(c => categoryVisible[c] = true);

let seasonalVisible = true;
let yearRoundVisible = true;
let fountainVisible = false;
let openNowVisible = false;

function isOpenNow(locId) {
  const loc = locations.find(l => l.id === locId);
  if (!loc) return 'unknown';

  // Seasonal check: if seasonal and outside mid-Apr to mid-Oct, closed
  if (loc.seasonal) {
    const now = new Date();
    const month = now.getMonth(); // 0-indexed
    const day = now.getDate();
    // mid-Apr (month 3, day 15) to mid-Oct (month 9, day 15)
    const inSeason = (month > 3 && month < 9) ||
      (month === 3 && day >= 15) ||
      (month === 9 && day <= 15);
    if (!inSeason) return 'closed';
  }

  const hours = hoursData[locId];
  if (hours === undefined || hours === null) return 'unknown';

  // 24hr shorthand
  if (Array.isArray(hours) && hours[0] === 0 && hours[1] === 24) return 'open';

  const now = new Date();
  const dayNames = ['sun','mon','tue','wed','thu','fri','sat'];
  const dayKey = dayNames[now.getDay()];
  const currentHour = now.getHours() + now.getMinutes() / 60;

  const dayHours = hours[dayKey];
  if (dayHours === undefined || dayHours === null) return 'closed';

  const [openH, closeH] = dayHours;
  if (closeH <= openH) {
    // Wraps past midnight (e.g., [5,1] means 5am to 1am next day)
    return (currentHour >= openH || currentHour < closeH) ? 'open' : 'closed';
  }
  return (currentHour >= openH && currentHour < closeH) ? 'open' : 'closed';
}

function createIcon(color, is24hr, catKey, hasWaterFountain) {
  const size = is24hr ? 36 : 32;

  // Symbol mapping for different categories (for non-color-dependent identification)
  const symbols = {
    university: 'üéì',
    public_bldg: 'üèõÔ∏è',
    hospital: '‚äï',
    transit: 'T',
    parks: 'üå≥',
    recreation_centers: 'üèä',
    sports_fields: '‚öΩ',
    attractions: '‚òÖ',
    coffee: '‚òï',
    hotel: 'üè®',
    other: '‚Ä¢'
  };

  const symbol = symbols[catKey] || '‚óè';
  const border = is24hr ? '3px solid #FFD700' : '2px solid rgba(255,255,255,0.9)';
  const glow = is24hr
    ? '0 0 8px rgba(255,215,0,0.6), 0 0 0 2px rgba(0,0,0,0.2)'
    : '0 0 6px rgba(0,0,0,0.3)';

  const wfBadge = hasWaterFountain
    ? '<span class="wf-badge">üö∞</span>'
    : '';

  return L.divIcon({
    className: '',
    html: `<div style="
      position:relative;
      width:${size}px;
      height:${size}px;
      border-radius:50%;
      background:${color};
      border:${border};
      box-shadow:${glow};
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:${is24hr ? '18px' : '16px'};
      font-weight:bold;
      color:white;
      text-shadow: 0 0 2px rgba(0,0,0,0.8);
      flex-shrink:0;
    ">${symbol}${wfBadge}</div>`,
    iconSize: [size, size],
    iconAnchor: [size/2, size/2],
    popupAnchor: [0, -size/2]
  });
}

function createFountainIcon() {
  return L.divIcon({
    className: '',
    html: `<div style="
      width:28px;
      height:28px;
      border-radius:50%;
      background:#2196F3;
      border:2px solid rgba(255,255,255,0.9);
      box-shadow:0 0 6px rgba(0,0,0,0.3);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:16px;
      flex-shrink:0;
    ">üö∞</div>`,
    iconSize: [28, 28],
    iconAnchor: [14, 14],
    popupAnchor: [0, -14]
  });
}

function buildPopup(loc) {
  const hasWf = waterFountainIds.has(loc.id);
  const seasonTag = loc.seasonal
    ? '<span class="popup-tag tag-seasonal">SEASONAL</span>'
    : '<span class="popup-tag tag-yearround">YEAR-ROUND</span>';
  const hrTag = loc.is24hr ? ' <span class="popup-tag tag-24hr">24 HR</span>' : '';
  const wfTag = hasWf ? ' <span class="popup-tag tag-fountain">WATER FOUNTAIN</span>' : '';

  const status = isOpenNow(loc.id);
  let statusTag = '';
  if (status === 'open') statusTag = ' <span class="popup-tag tag-open">OPEN NOW</span>';
  else if (status === 'closed') statusTag = ' <span class="popup-tag tag-closed">CLOSED</span>';
  else statusTag = ' <span class="popup-tag tag-unknown">HOURS UNKNOWN</span>';

  return `
    <div class="popup-title">#${loc.id} ${loc.name}</div>
    ${seasonTag}${hrTag}${wfTag}${statusTag}<br>
    ${loc.desc}<br>
    <strong>Hours:</strong> ${loc.hours}<br>
    <em style="font-size:11px;color:#666;">${loc.lat.toFixed(4)}, ${loc.lng.toFixed(4)}</em>
  `;
}

locations.forEach(loc => {
  const color = catColors[loc.cat];
  const hasWf = waterFountainIds.has(loc.id);
  const icon = createIcon(color, loc.is24hr, loc.cat, hasWf);

  const marker = L.marker([loc.lat, loc.lng], {icon});
  // Bind popup dynamically so open/closed status is always current
  marker.on('click', function() {
    this.unbindPopup();
    this.bindPopup(buildPopup(loc)).openPopup();
  });
  marker._locData = loc;
  marker.addTo(map);
  markers.push(marker);
});

// Create fountain-only markers (hidden by default)
const fountainMarkers = [];
fountainLocations.forEach(fl => {
  const icon = createFountainIcon();
  const seasonTag = fl.seasonal
    ? '<span class="popup-tag tag-seasonal">SEASONAL</span>'
    : '<span class="popup-tag tag-yearround">YEAR-ROUND</span>';

  const popup = `
    <div class="popup-title">üö∞ ${fl.name}</div>
    ${seasonTag} <span class="popup-tag tag-fountain">WATER FOUNTAIN</span><br>
    ${fl.desc}<br>
    <strong>Hours:</strong> ${fl.hours}<br>
    <em style="font-size:11px;color:#666;">${fl.lat.toFixed(4)}, ${fl.lng.toFixed(4)}</em>
  `;

  const marker = L.marker([fl.lat, fl.lng], {icon}).bindPopup(popup);
  marker._fountainData = fl;
  fountainMarkers.push(marker);
});

function updateVisibility() {
  markers.forEach(m => {
    const loc = m._locData;
    const catOk = categoryVisible[loc.cat];
    const seaOk = loc.seasonal ? seasonalVisible : yearRoundVisible;
    const openOk = !openNowVisible || isOpenNow(loc.id) !== 'closed';
    if (catOk && seaOk && openOk) {
      m.addTo(map);
    } else {
      map.removeLayer(m);
    }
  });

  // Toggle fountain-only markers
  fountainMarkers.forEach(m => {
    const fl = m._fountainData;
    const seaOk = fl.seasonal ? seasonalVisible : yearRoundVisible;
    if (fountainVisible && seaOk) {
      m.addTo(map);
    } else {
      map.removeLayer(m);
    }
  });

  // Toggle fountain badges on bathroom markers
  const mapEl = document.getElementById('map');
  if (fountainVisible) {
    mapEl.classList.add('show-fountains');
  } else {
    mapEl.classList.remove('show-fountains');
  }
}

// Legend
const symbols = {
  university: 'üéì',
  public_bldg: 'üèõÔ∏è',
  hospital: '‚äï',
  transit: 'T',
  parks: 'üå≥',
  recreation_centers: 'üèä',
  sports_fields: '‚öΩ',
  attractions: '‚òÖ',
  coffee: '‚òï',
  hotel: 'üè®',
  other: '‚Ä¢'
};

function downloadCSV() {
  let csv = 'Title,Description,Latitude,Longitude\n';

  locations.forEach(loc => {
    const wf = waterFountainIds.has(loc.id) ? ' [Water Fountain]' : '';
    const title = `${loc.name}${wf} (${loc.hours})`;
    const desc = loc.desc.replace(/"/g, '""'); // Escape quotes in CSV
    csv += `"${title}","${desc}",${loc.lat},${loc.lng}\n`;
  });

  fountainLocations.forEach(fl => {
    const title = `üö∞ ${fl.name} (${fl.hours})`;
    const desc = fl.desc.replace(/"/g, '""');
    csv += `"${title}","${desc}",${fl.lat},${fl.lng}\n`;
  });

  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  const url = URL.createObjectURL(blob);
  link.setAttribute('href', url);
  link.setAttribute('download', 'boston-bathrooms.csv');
  link.click();
}

const legend = L.control({position: 'bottomright'});
legend.onAdd = function() {
  const div = L.DomUtil.create('div', 'legend');
  L.DomEvent.disableClickPropagation(div);
  L.DomEvent.disableScrollPropagation(div);

  div.innerHTML = '<h3>Categories</h3>';

  Object.keys(catColors).forEach(cat => {
    const symbol = symbols[cat];
    const itemHtml = `<div class="legend-item" data-cat="${cat}">
      <div class="legend-dot" style="background:${catColors[cat]}">${symbol}</div>
      ${catNames[cat]}
    </div>`;
    div.innerHTML += itemHtml;
  });

  div.innerHTML += '<div class="legend-separator"></div>';
  div.innerHTML += '<h3 style="margin-bottom: 6px; margin-top: 0;">Amenities</h3>';
  div.innerHTML += '<div class="legend-item"><div class="legend-dot" style="background:#666;border:3px solid #FFD700;">‚úì</div>24-hour access</div>';

  div.innerHTML += '<div class="legend-separator"></div>';
  div.innerHTML += '<h3 style="margin-bottom: 6px; margin-top: 0;">Filters</h3>';
  div.innerHTML += '<div class="legend-item dimmed" data-toggle="fountains"><div class="legend-dot" style="background:#2196F3">üö∞</div>Water Fountains</div>';
  div.innerHTML += '<div class="legend-item" data-toggle="yearround"><div class="legend-dot" style="background:#28a745">‚ùÑÔ∏è</div>Year-round</div>';
  div.innerHTML += '<div class="legend-item" data-toggle="seasonal"><div class="legend-dot" style="background:#fd7e14">‚òÄÔ∏è</div>Seasonal</div>';
  div.innerHTML += '<div class="legend-item dimmed" data-toggle="opennow"><div class="legend-dot" style="background:#28a745">üïê</div>Open Now</div>';

  div.innerHTML += '<div class="legend-separator"></div>';
  div.innerHTML += '<button class="download-btn" onclick="downloadCSV()">üì• Download for Google Maps</button>';

  // Add click handlers to categories
  div.querySelectorAll('[data-cat]').forEach(item => {
    item.addEventListener('click', function() {
      const cat = this.dataset.cat;
      categoryVisible[cat] = !categoryVisible[cat];
      this.classList.toggle('dimmed');
      updateVisibility();
    });
  });

  // Add click handlers to toggle filters
  div.querySelectorAll('[data-toggle]').forEach(item => {
    item.addEventListener('click', function() {
      const toggle = this.dataset.toggle;
      this.classList.toggle('dimmed');
      const active = !this.classList.contains('dimmed');
      if (toggle === 'yearround') yearRoundVisible = active;
      else if (toggle === 'seasonal') seasonalVisible = active;
      else if (toggle === 'fountains') fountainVisible = active;
      else if (toggle === 'opennow') openNowVisible = active;
      updateVisibility();
    });
  });

  return div;
};
legend.addTo(map);

// --- Mobile bottom sheet logic ---
(function() {
  const toggleBtn = document.getElementById('legendToggle');
  const overlay = document.getElementById('legendOverlay');
  const sheet = document.getElementById('legendSheet');
  const sheetContent = document.getElementById('sheetContent');
  const sheetClose = document.getElementById('sheetClose');

  function isMobile() {
    return window.matchMedia('(max-width: 640px)').matches;
  }

  function openSheet() {
    overlay.style.display = 'block';
    sheet.style.display = 'block';
    // Force reflow before adding class for transition
    sheet.offsetHeight;
    sheet.classList.add('open');
  }

  function closeSheet() {
    sheet.classList.remove('open');
    sheet.addEventListener('transitionend', function handler() {
      sheet.removeEventListener('transitionend', handler);
      sheet.style.display = 'none';
      overlay.style.display = 'none';
    });
  }

  function buildSheetContent() {
    let html = '<h3 style="margin-bottom:8px;font-size:14px;font-weight:600;">Categories</h3>';

    Object.keys(catColors).forEach(cat => {
      const symbol = symbols[cat];
      const dimmed = categoryVisible[cat] ? '' : ' dimmed';
      html += `<div class="legend-item${dimmed}" data-cat="${cat}">
        <div class="legend-dot" style="background:${catColors[cat]}">${symbol}</div>
        ${catNames[cat]}
      </div>`;
    });

    html += '<div class="legend-separator"></div>';
    html += '<h3 style="margin-bottom:6px;font-size:14px;font-weight:600;">Amenities</h3>';
    html += '<div class="legend-item"><div class="legend-dot" style="background:#666;border:3px solid #FFD700;">‚úì</div>24-hour access</div>';
    html += '<div class="legend-separator"></div>';
    html += '<h3 style="margin-bottom:6px;font-size:14px;font-weight:600;">Filters</h3>';
    html += `<div class="legend-item${fountainVisible ? '' : ' dimmed'}" data-toggle="fountains"><div class="legend-dot" style="background:#2196F3">üö∞</div>Water Fountains</div>`;
    html += `<div class="legend-item${yearRoundVisible ? '' : ' dimmed'}" data-toggle="yearround"><div class="legend-dot" style="background:#28a745">‚ùÑÔ∏è</div>Year-round</div>`;
    html += `<div class="legend-item${seasonalVisible ? '' : ' dimmed'}" data-toggle="seasonal"><div class="legend-dot" style="background:#fd7e14">‚òÄÔ∏è</div>Seasonal</div>`;
    html += `<div class="legend-item${openNowVisible ? '' : ' dimmed'}" data-toggle="opennow"><div class="legend-dot" style="background:#28a745">üïê</div>Open Now</div>`;
    html += '<div class="legend-separator"></div>';
    html += '<button class="download-btn" onclick="downloadCSV()">üì• Download for Google Maps</button>';

    sheetContent.innerHTML = html;

    // Wire up category clicks
    sheetContent.querySelectorAll('[data-cat]').forEach(item => {
      item.addEventListener('click', function() {
        const cat = this.dataset.cat;
        categoryVisible[cat] = !categoryVisible[cat];
        this.classList.toggle('dimmed');
        // Also sync the desktop legend if it exists
        const desktopItem = document.querySelector(`.legend [data-cat="${cat}"]`);
        if (desktopItem) desktopItem.classList.toggle('dimmed', !categoryVisible[cat]);
        updateVisibility();
      });
    });

    // Wire up filter toggles
    sheetContent.querySelectorAll('[data-toggle]').forEach(item => {
      item.addEventListener('click', function() {
        const toggle = this.dataset.toggle;
        this.classList.toggle('dimmed');
        const active = !this.classList.contains('dimmed');
        if (toggle === 'yearround') yearRoundVisible = active;
        else if (toggle === 'seasonal') seasonalVisible = active;
        else if (toggle === 'fountains') fountainVisible = active;
        else if (toggle === 'opennow') openNowVisible = active;
        // Sync desktop legend
        const desktopItem = document.querySelector(`.legend [data-toggle="${toggle}"]`);
        if (desktopItem) desktopItem.classList.toggle('dimmed', !active);
        updateVisibility();
      });
    });
  }

  toggleBtn.addEventListener('click', function() {
    buildSheetContent();
    openSheet();
  });

  overlay.addEventListener('click', closeSheet);
  sheetClose.addEventListener('click', closeSheet);
})();

// --- Locate me ---
(function() {
  const btn = document.getElementById('locateBtn');
  let userMarker = null;
  let userRing = null;

  btn.addEventListener('click', function() {
    if (!navigator.geolocation) {
      alert('Geolocation is not supported by your browser.');
      return;
    }

    btn.classList.add('locating');

    navigator.geolocation.getCurrentPosition(
      function(pos) {
        btn.classList.remove('locating');
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;
        const accuracy = pos.coords.accuracy;

        // Remove old markers if re-locating
        if (userMarker) map.removeLayer(userMarker);
        if (userRing) map.removeLayer(userRing);

        // Accuracy circle
        userRing = L.circle([lat, lng], {
          radius: accuracy,
          color: '#4285F4',
          fillColor: '#4285F4',
          fillOpacity: 0.1,
          weight: 1,
          interactive: false
        }).addTo(map);

        // Blue dot
        userMarker = L.marker([lat, lng], {
          icon: L.divIcon({
            className: '',
            html: '<div style="position:relative;width:40px;height:40px;display:flex;align-items:center;justify-content:center;">' +
                  '<div class="user-location-ring" style="position:absolute;"></div>' +
                  '<div class="user-location-dot"></div>' +
                  '</div>',
            iconSize: [40, 40],
            iconAnchor: [20, 20]
          }),
          zIndexOffset: 1000,
          interactive: false
        }).addTo(map);

        map.setView([lat, lng], Math.max(map.getZoom(), 15));
      },
      function(err) {
        btn.classList.remove('locating');
        if (err.code === 1) {
          alert('Location access was denied. Please enable location permissions for this site.');
        } else {
          alert('Could not determine your location. Please try again.');
        }
      },
      { enableHighAccuracy: true, timeout: 10000, maximumAge: 30000 }
    );
  });
})();

</script>
</body>
</html>
